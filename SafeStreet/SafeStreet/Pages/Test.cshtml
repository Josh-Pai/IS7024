@page
@model SafeStreet.Pages.TestModel
@{
    ViewData["Title"] = "Crime Data Analysis";
}

<h1>Crime Data Analysis</h1>

<!-- Map and Search Box -->
<div id="map-container">
    <input id="search-box" type="text" placeholder="Search for a place..." />
    <div id="map"></div>
</div>

<!-- Statistics Section -->
<div id="statistics">
    <h2>Crime Statistics (Nearby - 1 km Radius)</h2>
    <p><strong>Last 1 Month:</strong> <span id="last1Month">-</span></p>
    <p><strong>Last 3 Months:</strong> <span id="last3Months">-</span></p>
    <p><strong>Last 6 Months:</strong> <span id="last6Months">-</span></p>
    <p><strong>Last 1 Year:</strong> <span id="last1Year">-</span></p>
</div>

@section Scripts {
    <script src="https://maps.googleapis.com/maps/api/js?key=@Model.GoogleMapApiKey&libraries=places&callback=initMap" async defer></script>
    <script>
        let map, searchBox, geocoder;

        function initMap() {
            const initialLocation = { lat: 39.1031, lng: -84.5120 }; // Default to Cincinnati
            map = new google.maps.Map(document.getElementById('map'), {
                center: initialLocation,
                zoom: 12
            });

            // Initialize geocoder
            geocoder = new google.maps.Geocoder();

            // Initialize the search box
            const input = document.getElementById('search-box');
            searchBox = new google.maps.places.SearchBox(input);

            // Bias the search box results towards the current map bounds
            map.addListener('bounds_changed', () => {
                searchBox.setBounds(map.getBounds());
            });

            // Listen for the user's search selection
            searchBox.addListener('places_changed', () => {
                const places = searchBox.getPlaces();
                if (places.length === 0) return;

                const place = places[0]; // Use the first place selected
                if (!place.geometry || !place.geometry.location) return;

                const latitude = place.geometry.location.lat();
                const longitude = place.geometry.location.lng();

                // Center the map on the selected place
                map.setCenter(place.geometry.location);
                map.setZoom(14);

                // Fetch stats for the selected location
                fetchCrimeStats(latitude, longitude);
            });

            // Listen for map click events
            map.addListener('click', (event) => {
                const latitude = event.latLng.lat();
                const longitude = event.latLng.lng();

                // Use Reverse Geocoding to get the address of the clicked location
                geocoder.geocode({ location: { lat: latitude, lng: longitude } }, (results, status) => {
                    if (status === "OK" && results[0]) {
                        // Update the search box with the formatted address
                        input.value = results[0].formatted_address;
                    } else {
                        console.error("Geocoder failed due to: " + status);
                    }
                });

                // Fetch stats for the clicked location
                fetchCrimeStats(latitude, longitude);
            });
        }

        async function fetchCrimeStats(latitude, longitude) {
            try {
                document.getElementById('last1Month').textContent = "Loading...";
                document.getElementById('last3Months').textContent = "Loading...";
                document.getElementById('last6Months').textContent = "Loading...";
                document.getElementById('last1Year').textContent = "Loading...";

                const response = await fetch(`/Test?handler=CrimeStatsNearby&latitude=${latitude}&longitude=${longitude}`);
                if (!response.ok) {
                    console.error("Error fetching crime stats");
                    return;
                }

                const stats = await response.json();
                console.log("stats: ", stats)

                // Update the statistics in the UI
                document.getElementById('last1Month').textContent = stats.last1Month;
                document.getElementById('last3Months').textContent = stats.last3Months;
                document.getElementById('last6Months').textContent = stats.last6Months;
                document.getElementById('last1Year').textContent = stats.last1Year;
            } catch (error) {
                console.error("Error fetching crime stats:", error);
            }
        }
    </script>
    <style>
        #map-container {
            position: relative;
            width: 100%;
            height: 500px;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        #search-box {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 5;
            width: 300px;
            height: 40px;
            font-size: 14px;
            padding: 5px 10px;
            border: none;
            outline: none;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        #statistics {
            margin-top: 20px;
        }

            #statistics p {
                font-size: 16px;
            }
    </style>
}
